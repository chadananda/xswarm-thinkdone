---
import '../../styles/global.css';
import TodoList from '../../components/TodoList.svelte';
import { getUser } from '../../lib/user.js';
import { readTasks } from '../../lib/tasks.js';

// TODO: Authenticate from session/cookie — for now, resolve from env
const user = getUser();

const { date, tasks } = readTasks(user.workspace);
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#8b4513">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Think &rarr; Done</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Patrick+Hand&family=Inter:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="page">
      <header class="brand">
        <div class="brand-grid">
          <a href="/" class="brand-icon" target="_blank" title="Think → Done">
            <img src="/favicon.png" alt="" />
          </a>
          <div class="brand-main">
            <div class="brand-row">
              <h1>Think<span class="text-gold">Done</span></h1>
              <div class="brand-right">
                <span class="clock" id="clock"></span>
                <button class="header-btn meet-btn" id="meetBtn" title="Planning meeting">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    <path d="M8 9h8"/><path d="M8 13h4"/>
                  </svg>
                </button>
                <div class="hamburger-wrap">
                  <button class="header-btn hamburger-btn" id="hamburgerBtn" title="Menu">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                      <line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/>
                    </svg>
                  </button>
                  <div class="hamburger-menu" id="hamburgerMenu">
                    <button class="hm-item" id="hmMeetBtn">
                      <span class="hm-icon">&#128172;</span> Planning Meeting
                    </button>
                    <a href="/" class="hm-item">
                      <span class="hm-icon">&#127968;</span> Home
                    </a>
                    <a href="/settings" class="hm-item">
                      <span class="hm-icon">&#9881;</span> Settings
                    </a>
                  </div>
                </div>
              </div>
            </div>
            <div class="quote" id="quote"></div>
          </div>
        </div>
      </header>
      <main>
        <TodoList client:load initialTasks={tasks} initialDate={date} userName={user.name} />
      </main>
  </div>

  <script>
    const QUOTES = [
      "Done is the engine of more.",
      "Finished is better than perfect.",
      "Small steps still move you forward.",
      "What gets scheduled gets done.",
      "Progress, not perfection.",
      "Today\u2019s priorities shape tomorrow\u2019s possibilities.",
      "The best plan is the one you actually follow.",
      "Clarity precedes action.",
      "Less deciding, more doing.",
      "Your future self will thank you.",
      "Focus is saying no to good ideas.",
      "Action cures anxiety.",
      "Ship it. Then improve it.",
      "One thing at a time. Most important thing first.",
      "Think strategically. Execute relentlessly.",
    ];
    let qi = Math.floor(Math.random() * QUOTES.length);
    const quoteEl = document.getElementById('quote');
    if (quoteEl) {
      const TYPE_SPEED = 38;
      const UNTYPE_SPEED = 22;
      const PAUSE = 8000;
      let full = '', pos = 0, typing = true;

      function tick() {
        if (typing) {
          pos++;
          quoteEl.textContent = full.slice(0, pos);
          if (pos < full.length) setTimeout(tick, TYPE_SPEED);
          else setTimeout(() => { typing = false; tick(); }, PAUSE);
        } else {
          pos--;
          quoteEl.textContent = pos > 0 ? full.slice(0, pos) : '';
          if (pos > 0) setTimeout(tick, UNTYPE_SPEED);
          else { qi = (qi + 1) % QUOTES.length; startQuote(); }
        }
      }

      function startQuote() {
        full = QUOTES[qi]; pos = 0; typing = true; tick();
      }

      startQuote();
    }

    // Compact clock
    function updateClock() {
      const el = document.getElementById('clock');
      if (!el) return;
      const now = new Date();
      const date = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const time = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      el.textContent = `${date} \u00b7 ${time}`;
    }
    updateClock();
    setInterval(updateClock, 30000);

    // Hamburger menu toggle
    const hmBtn = document.getElementById('hamburgerBtn');
    const hmMenu = document.getElementById('hamburgerMenu');
    hmBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      hmMenu?.classList.toggle('open');
    });
    document.addEventListener('click', () => hmMenu?.classList.remove('open'));

    // Meeting — open in a named window (fixed name prevents duplicates)
    function openMeeting() {
      const w = 700, h = screen.availHeight - 50;
      const left = Math.max(0, screen.availWidth - w - 20);
      const top = 20;
      window.open('/meeting', 'thinkdone-meeting',
        `width=${w},height=${h},left=${left},top=${top},menubar=no,toolbar=no,status=no`);
    }
    document.getElementById('meetBtn')?.addEventListener('click', openMeeting);
    document.getElementById('hmMeetBtn')?.addEventListener('click', () => {
      hmMenu?.classList.remove('open');
      openMeeting();
    });

    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>

<style is:global>
  html, body {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  html::-webkit-scrollbar,
  body::-webkit-scrollbar {
    display: none;
  }

  .page {
    max-width: 520px;
    margin: 0 auto;
    padding: 0 1rem 1.5rem;
    min-height: 100vh;
    border-left: 2px solid var(--color-margin);
    border-right: 1px solid var(--color-rule);
    background:
      linear-gradient(oklch(0.78 0.02 70 / 0.18) 1px, transparent 1px),
      linear-gradient(90deg, oklch(0.78 0.02 70 / 0.18) 1px, transparent 1px),
      color-mix(in srgb, var(--color-paper-bright) 50%, transparent);
    background-size: 20px 20px, 20px 20px, auto;
  }

  @media (max-width: 540px) {
    .page {
      padding: 0 0.4rem 1rem;
      border-left: none;
      border-right: none;
      max-width: 100%;
    }
  }

  .brand {
    padding: 0.15rem 1rem 0.1rem;
    border-bottom: 2px solid var(--color-ink-faint);
    margin: 0 -1rem 0.15rem;
    position: sticky;
    top: 0;
    background: color-mix(in srgb, var(--color-paper) 97%, transparent);
    z-index: 10;
    backdrop-filter: blur(8px);
  }
  .brand-grid {
    display: flex;
    gap: 0;
    align-items: stretch;
  }
  .brand-icon {
    display: flex;
    align-items: center;
    text-decoration: none;
    flex-shrink: 0;
    align-self: stretch;
  }
  .brand-icon img {
    width: auto;
    height: 56px;
    margin: -4px 0;
    position: relative;
    left: -4px;
    border-radius: 10px;
    transition: transform 0.2s, filter 0.2s;
    filter: drop-shadow(0 1px 4px rgba(0,0,0,0.15));
  }
  .brand-icon:hover img {
    transform: scale(1.08) rotate(-2deg);
    filter: drop-shadow(0 3px 8px rgba(0,0,0,0.25));
  }
  .brand-main {
    flex: 1;
    min-width: 0;
    padding-top: 2px;
  }
  .brand-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }
  .brand-right {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }
  .brand h1 {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--color-ink-light);
    line-height: 1;
    white-space: nowrap;
  }
  .brand h1 .text-gold { color: var(--color-gold); }
  .brand .clock {
    font-family: var(--font-ui);
    font-size: 0.65rem;
    color: var(--color-ink-muted);
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  .header-btn {
    appearance: none;
    border: 1px solid var(--color-ink-faint);
    background: transparent;
    color: var(--color-ink-muted);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.15s, border-color 0.15s, background 0.15s;
    padding: 0;
  }
  .header-btn:hover {
    color: var(--color-accent);
    border-color: var(--color-accent);
    background: rgba(139,69,19,0.05);
  }
  .hamburger-wrap {
    position: relative;
  }
  .hamburger-btn {
    width: 26px; height: 26px;
    padding: 4px;
  }
  .hamburger-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 4px;
    background: var(--color-paper-bright);
    border: 1px solid var(--color-ink-faint);
    border-radius: 6px;
    box-shadow: 0 4px 16px rgba(139,69,19,0.12), 0 2px 6px rgba(0,0,0,0.08);
    min-width: 140px;
    padding: 4px 0;
    z-index: 300;
    animation: hmFade 0.12s ease-out;
  }
  .hamburger-menu.open { display: block; }
  @keyframes hmFade {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .hm-item {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 8px 14px;
    font-family: var(--font-ui);
    font-size: 0.8rem;
    color: var(--color-ink);
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    text-align: left;
    transition: background 0.1s;
  }
  .hm-item:hover { background: rgba(139,69,19,0.05); }
  .hm-icon { font-size: 0.9rem; width: 18px; text-align: center; }

  .meet-btn {
    width: 26px; height: 26px;
    padding: 4px;
  }
  .brand .quote {
    font-family: var(--font-display);
    font-size: 1.25rem;
    color: var(--color-ink-muted);
    font-style: italic;
    margin-top: -0.1rem;
    min-height: 1.2em;
    line-height: 1.1;
  }
</style>
